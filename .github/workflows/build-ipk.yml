name: Build OpenWRT IPK Package

# NOTE: 手动触发，支持选择目标架构和版本号
on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例: 1.0.0)'
        required: true
        default: '0.1.0'
      target_arch:
        description: '目标架构'
        required: true
        type: choice
        default: 'x86_64'
        options:
          - x86_64
          - aarch64
          - all

concurrency:
  group: build-ipk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      # NOTE: 显式指定 pnpm 10.24.0，与 package.json packageManager 字段一致
      - uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.24.0

      - uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: '22'

      # NOTE: 调试 pnpm 版本确认
      - name: Check pnpm version
        run: |
          echo "pnpm version: $(pnpm --version)"
          echo "node version: $(node --version)"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # NOTE: 使用 pnpm build (turbo) 按依赖顺序构建所有 workspace 包
      # dae-lsp, dae-editor 等包需要先构建，web app 才能成功引用
      - name: Build Web UI
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          TURBO_TELEMETRY_DISABLED: 1
          DO_NOT_TRACK: 1
        run: pnpm build

      - uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist/
          retention-days: 1

  build-ipk:
    needs: build-web
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # NOTE: 根据用户选择的架构生成对应的构建矩阵
          - goos: linux
            goarch: amd64
            goamd64: v1
            openwrt_arch: x86_64
            enabled: ${{ github.event.inputs.target_arch == 'x86_64' || github.event.inputs.target_arch == 'all' }}

          - goos: linux
            goarch: arm64
            openwrt_arch: aarch64
            enabled: ${{ github.event.inputs.target_arch == 'aarch64' || github.event.inputs.target_arch == 'all' }}
      fail-fast: false

    # NOTE: 仅在 build-web 成功后运行，且不因其他矩阵任务失败而取消
    if: ${{ !cancelled() && needs.build-web.result == 'success' }}

    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      CGO_ENABLED: 0
      VERSION: ${{ github.event.inputs.version }}

    steps:
      - name: Check if this arch is enabled
        id: check
        run: |
          if [ "${{ matrix.enabled }}" != "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping ${{ matrix.openwrt_arch }} build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v6
        if: steps.check.outputs.skip != 'true'
        with:
          submodules: recursive

      - uses: actions/setup-go@v6
        if: steps.check.outputs.skip != 'true'
        with:
          go-version: '1.24'
          cache: false

      - uses: actions/download-artifact@v4
        if: steps.check.outputs.skip != 'true'
        with:
          name: web-dist
          path: dist/

      # NOTE: 编译 daed 二进制（内嵌 Web UI + dae-wing 后端）
      - name: Build daed binary
        if: steps.check.outputs.skip != 'true'
        run: |
          export GOFLAGS="-trimpath -modcacherw"
          export OUTPUT=daed
          make SKIP_SUBMODULES=1

      # NOTE: 下载 GeoIP/GeoSite 数据文件
      - name: Download geo data
        if: steps.check.outputs.skip != 'true'
        run: |
          curl -L -o geoip.dat https://github.com/v2rayA/dist-v2ray-rules-dat/raw/master/geoip.dat
          curl -L -o geosite.dat https://github.com/v2rayA/dist-v2ray-rules-dat/raw/master/geosite.dat

      # NOTE: 构建 IPK 目录结构
      - name: Prepare IPK structure
        if: steps.check.outputs.skip != 'true'
        run: |
          PKG_DIR="daed-ipk"
          INSTALLED_SIZE=$(stat -c %s daed)

          # 创建 CONTROL 目录
          mkdir -p "$PKG_DIR/CONTROL"

          cat > "$PKG_DIR/CONTROL/control" << EOF
          Package: daed
          Version: ${{ github.event.inputs.version }}
          Architecture: ${{ matrix.openwrt_arch }}
          Maintainer: coolhuasen
          Section: net
          Priority: optional
          Depends: kmod-bpf, kmod-nft-tproxy, ca-bundle
          Installed-Size: $INSTALLED_SIZE
          Description: daed - A Modern Dashboard For dae (eBPF transparent proxy)
           daed is a high-performance transparent proxy solution based on eBPF.
           It bundles dae-wing backend with a modern web dashboard.
          Homepage: https://github.com/coolhuasen/daed
          EOF

          # HACK: 去除 heredoc 产生的前导空格
          sed -i 's/^          //' "$PKG_DIR/CONTROL/control"

          # 复制安装脚本
          cp install/openwrt/postinst "$PKG_DIR/CONTROL/postinst"
          cp install/openwrt/prerm "$PKG_DIR/CONTROL/prerm"
          chmod 755 "$PKG_DIR/CONTROL/postinst"
          chmod 755 "$PKG_DIR/CONTROL/prerm"

          # 创建数据目录结构
          mkdir -p "$PKG_DIR/usr/bin"
          mkdir -p "$PKG_DIR/etc/init.d"
          mkdir -p "$PKG_DIR/etc/config"
          mkdir -p "$PKG_DIR/usr/share/daed"

          # 复制文件
          cp daed "$PKG_DIR/usr/bin/daed"
          chmod 755 "$PKG_DIR/usr/bin/daed"

          cp install/openwrt/init.d/daed "$PKG_DIR/etc/init.d/daed"
          chmod 755 "$PKG_DIR/etc/init.d/daed"

          cp install/openwrt/config/daed "$PKG_DIR/etc/config/daed"

          cp geoip.dat "$PKG_DIR/usr/share/daed/geoip.dat"
          cp geosite.dat "$PKG_DIR/usr/share/daed/geosite.dat"

          # 配置文件声明（防止升级时覆盖用户配置）
          cat > "$PKG_DIR/CONTROL/conffiles" << EOF
          /etc/config/daed
          EOF
          sed -i 's/^          //' "$PKG_DIR/CONTROL/conffiles"

          echo "=== IPK package structure ==="
          find "$PKG_DIR" -type f | sort
          echo "=== CONTROL/control ==="
          cat "$PKG_DIR/CONTROL/control"

      # NOTE: 零外部依赖构建 IPK (兼容性优化版)
      # 1. 强制 tar --format=gnu 避免 pax headers 兼容性问题
      # 2. Python 脚本精确构建 ar 归档，文件名使用空格填充而非斜杠后缀
      - name: Build IPK package
        if: steps.check.outputs.skip != 'true'
        run: |
          set -e
          export FINAL_NAME="daed_${{ github.event.inputs.version }}_${{ matrix.openwrt_arch }}.ipk"
          PKG_DIR="daed-ipk"
          export TMP_DIR=$(mktemp -d)

          # 1. debian-binary
          printf '2.0\n' > "$TMP_DIR/debian-binary"

          # 2. control.tar.gz
          # 强制使用 GNU 格式，避免 pax headers (opkg 不喜欢)
          # --sort=name --mtime="..." 确保可重现构建
          tar --format=gnu --sort=name --mtime='@1704067200' \
              --owner=0 --group=0 --numeric-owner \
              -C "$PKG_DIR/CONTROL" -czf "$TMP_DIR/control.tar.gz" .

          # 3. data.tar.gz
          tar --format=gnu --sort=name --mtime='@1704067200' \
              --owner=0 --group=0 --numeric-owner \
              -C "$PKG_DIR" --exclude='./CONTROL' -czf "$TMP_DIR/data.tar.gz" .

          # 4. 用 Python 精确构建 ar 归档 (标准 System V ar 格式)
          python3 << 'PYEOF'
          import struct, os, time

          def ar_member(name, data):
              # opkg 兼容性关键：文件名必须用空格填充，不能有 '/' 后缀 (GNU ar 默认有 /)
              name_field = name.encode().ljust(16)
              
              # 固定时间戳以保证确定性，虽然 ar 头并不是关键
              mtime = b'1704067200  ' 
              uid = b'0     '
              gid = b'0     '
              mode = b'100644  '
              size = str(len(data)).encode().ljust(10)
              fmag = b'`\n'
              
              header = name_field + mtime + uid + gid + mode + size + fmag
              pad = b'\n' if len(data) % 2 else b''
              return header + data + pad

          tmp = os.environ.get('TMP_DIR', '/tmp')
          out = os.environ.get('FINAL_NAME', 'output.ipk')

          with open(f'{tmp}/debian-binary', 'rb') as f:
              db = f.read()
          with open(f'{tmp}/control.tar.gz', 'rb') as f:
              ctrl = f.read()
          with open(f'{tmp}/data.tar.gz', 'rb') as f:
              data = f.read()

          with open(out, 'wb') as f:
              f.write(b'!<arch>\n')
              f.write(ar_member('debian-binary', db))
              f.write(ar_member('control.tar.gz', ctrl))
              f.write(ar_member('data.tar.gz', data))

          print(f'IPK created: {out} ({os.path.getsize(out)} bytes)')
          PYEOF

          # 清理
          rm -rf "$TMP_DIR"

          echo "=== Generated IPK ==="
          ls -lh "$FINAL_NAME"
          echo "IPK_FILE=$FINAL_NAME" >> $GITHUB_ENV

          # 验证 IPK 结构
          echo "=== IPK ar members ==="
          ar t "$FINAL_NAME"

          # 尝试 opkg info 验证 (如果可用)
          if command -v opkg >/dev/null; then
             echo "=== opkg info verification ==="
             opkg info -f "$FINAL_NAME" || echo "opkg info failed check"
          fi

      - name: Upload IPK artifact
        if: steps.check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daed-ipk-${{ matrix.openwrt_arch }}
          path: ${{ env.IPK_FILE }}
          retention-days: 30
