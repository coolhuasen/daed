name: Build OpenWRT IPK Package

# NOTE: 手动触发，支持选择目标架构和版本号
on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号 (例: 1.0.0)'
        required: true
        default: '0.1.0'
      target_arch:
        description: '目标架构'
        required: true
        type: choice
        default: 'x86_64'
        options:
          - x86_64
          - aarch64
          - all

concurrency:
  group: build-ipk-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      # NOTE: 显式指定 pnpm 10.24.0，与 package.json packageManager 字段一致
      - uses: pnpm/action-setup@v4.2.0
        with:
          version: 10.24.0

      - uses: actions/setup-node@v6
        with:
          cache: pnpm
          node-version: '22'

      # NOTE: 调试 pnpm 版本确认
      - name: Check pnpm version
        run: |
          echo "pnpm version: $(pnpm --version)"
          echo "node version: $(node --version)"

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      # NOTE: 使用 pnpm build (turbo) 按依赖顺序构建所有 workspace 包
      # dae-lsp, dae-editor 等包需要先构建，web app 才能成功引用
      - name: Build Web UI
        env:
          NODE_OPTIONS: --max-old-space-size=4096
          TURBO_TELEMETRY_DISABLED: 1
          DO_NOT_TRACK: 1
        run: pnpm build

      - uses: actions/upload-artifact@v4
        with:
          name: web-dist
          path: apps/web/dist/
          retention-days: 1

  build-ipk:
    needs: build-web
    runs-on: ubuntu-latest

    strategy:
      matrix:
        include:
          # NOTE: 根据用户选择的架构生成对应的构建矩阵
          - goos: linux
            goarch: amd64
            goamd64: v1
            openwrt_arch: x86_64
            enabled: ${{ github.event.inputs.target_arch == 'x86_64' || github.event.inputs.target_arch == 'all' }}

          - goos: linux
            goarch: arm64
            openwrt_arch: aarch64
            enabled: ${{ github.event.inputs.target_arch == 'aarch64' || github.event.inputs.target_arch == 'all' }}
      fail-fast: false

    # NOTE: 仅在 build-web 成功后运行，且不因其他矩阵任务失败而取消
    if: ${{ !cancelled() && needs.build-web.result == 'success' }}

    env:
      GOOS: ${{ matrix.goos }}
      GOARCH: ${{ matrix.goarch }}
      GOAMD64: ${{ matrix.goamd64 }}
      CGO_ENABLED: 0
      VERSION: ${{ github.event.inputs.version }}

    steps:
      - name: Check if this arch is enabled
        id: check
        run: |
          if [ "${{ matrix.enabled }}" != "true" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skipping ${{ matrix.openwrt_arch }} build"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - uses: actions/checkout@v6
        if: steps.check.outputs.skip != 'true'
        with:
          submodules: recursive

      - uses: actions/setup-go@v6
        if: steps.check.outputs.skip != 'true'
        with:
          go-version: '1.24'
          cache: false

      - uses: actions/download-artifact@v4
        if: steps.check.outputs.skip != 'true'
        with:
          name: web-dist
          path: dist/

      # NOTE: 编译 daed 二进制（内嵌 Web UI + dae-wing 后端）
      - name: Build daed binary
        if: steps.check.outputs.skip != 'true'
        run: |
          export GOFLAGS="-trimpath -modcacherw"
          export OUTPUT=daed
          make SKIP_SUBMODULES=1

      # NOTE: 下载 GeoIP/GeoSite 数据文件
      - name: Download geo data
        if: steps.check.outputs.skip != 'true'
        run: |
          curl -L -o geoip.dat https://github.com/v2rayA/dist-v2ray-rules-dat/raw/master/geoip.dat
          curl -L -o geosite.dat https://github.com/v2rayA/dist-v2ray-rules-dat/raw/master/geosite.dat

      # NOTE: 构建 IPK 目录结构
      - name: Prepare IPK structure
        if: steps.check.outputs.skip != 'true'
        run: |
          PKG_DIR="daed-ipk"
          INSTALLED_SIZE=$(stat -c %s daed)

          # 创建 DEBIAN 目录 (dpkg-deb 标准)
          mkdir -p "$PKG_DIR/DEBIAN"

          cat > "$PKG_DIR/DEBIAN/control" << EOF
          Package: daed
          Version: ${{ github.event.inputs.version }}
          Architecture: ${{ matrix.openwrt_arch }}
          Maintainer: coolhuasen
          Section: net
          Priority: optional
          Depends: kmod-bpf, kmod-nft-tproxy, ca-bundle
          Installed-Size: $INSTALLED_SIZE
          Description: daed - A Modern Dashboard For dae (eBPF transparent proxy)
           daed is a high-performance transparent proxy solution based on eBPF.
           It bundles dae-wing backend with a modern web dashboard.
          Homepage: https://github.com/coolhuasen/daed
          EOF

          # HACK: 去除 heredoc 产生的前导空格
          sed -i 's/^          //' "$PKG_DIR/DEBIAN/control"

          # 复制安装脚本
          cp install/openwrt/postinst "$PKG_DIR/DEBIAN/postinst"
          cp install/openwrt/prerm "$PKG_DIR/DEBIAN/prerm"
          chmod 755 "$PKG_DIR/DEBIAN/postinst"
          chmod 755 "$PKG_DIR/DEBIAN/prerm"

          # 创建数据目录结构
          mkdir -p "$PKG_DIR/usr/bin"
          mkdir -p "$PKG_DIR/etc/init.d"
          mkdir -p "$PKG_DIR/etc/config"
          mkdir -p "$PKG_DIR/usr/share/daed"

          # 复制文件
          cp daed "$PKG_DIR/usr/bin/daed"
          chmod 755 "$PKG_DIR/usr/bin/daed"

          cp install/openwrt/init.d/daed "$PKG_DIR/etc/init.d/daed"
          chmod 755 "$PKG_DIR/etc/init.d/daed"

          cp install/openwrt/config/daed "$PKG_DIR/etc/config/daed"

          cp geoip.dat "$PKG_DIR/usr/share/daed/geoip.dat"
          cp geosite.dat "$PKG_DIR/usr/share/daed/geosite.dat"

          # 配置文件声明（防止升级时覆盖用户配置）
          # 配置文件声明（防止升级时覆盖用户配置）
          cat > "$PKG_DIR/DEBIAN/conffiles" << EOF
          /etc/config/daed
          EOF
          sed -i 's/^          //' "$PKG_DIR/DEBIAN/conffiles"

          echo "=== IPK package structure ==="
          find "$PKG_DIR" -type f | sort
          echo "=== DEBIAN/control ==="
          cat "$PKG_DIR/DEBIAN/control"

      # NOTE: 使用标准 dpkg-deb 工具构建 (IPK 本质就是 DEB)
      # 这是最稳妥的标准构建方式，自动处理 ar/tar 格式和权限
      - name: Build IPK package
        if: steps.check.outputs.skip != 'true'
        run: |
          set -e
          PKG_DIR="daed-ipk"

          # 定义最终文件名
          IPK_NAME="daed_${{ github.event.inputs.version }}_${{ matrix.openwrt_arch }}.ipk"

          # 使用 dpkg-deb 构建
          # --root-owner-group: 强制内容为 root:root
          # -Zgzip: 强制使用 gzip 压缩 (OpenWRT 兼容性必需，默认可能是 zstd/xz)
          # -b: build
          dpkg-deb --root-owner-group -Zgzip -b "$PKG_DIR" "$IPK_NAME"

          echo "=== Generated IPK ==="
          ls -lh "$IPK_NAME"
          echo "IPK_FILE=$IPK_NAME" >> $GITHUB_ENV

          # 验证 IPK 结构
          echo "=== IPK ar members ==="
          ar t "$IPK_NAME"

          # 尝试 opkg info 验证
          if command -v opkg >/dev/null; then
             echo "=== opkg info verification ==="
             opkg info -f "$IPK_NAME" || echo "opkg info failed check"
          fi

      - name: Upload IPK artifact
        if: steps.check.outputs.skip != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daed-ipk-${{ matrix.openwrt_arch }}
          path: ${{ env.IPK_FILE }}
          retention-days: 30
