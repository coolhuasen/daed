#!/bin/sh /etc/rc.common
# daed - A Modern Dashboard For dae (eBPF transparent proxy)
# NOTE: 使用 procd 管理 daed 服务的生命周期

USE_PROCD=1

# NOTE: START 优先级需在网络服务之后，确保接口已就绪
START=99
STOP=10

PROG=/usr/bin/daed
CONF_DIR=/etc/daed
LOG_FILE=/var/log/daed.log

start_service() {
    # NOTE: 检查二进制是否存在，避免启动失败时无明确报错
    [ -f "$PROG" ] || {
        echo "daed binary not found at $PROG" >&2
        return 1
    }

    mkdir -p "$CONF_DIR"

    procd_open_instance
    procd_set_param command "$PROG" run \
        --listen "0.0.0.0:2023" \
        --dir "$CONF_DIR"
    procd_set_param respawn 3600 5 5
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param file /etc/config/daed
    procd_close_instance
}

stop_service() {
    :
}

service_triggers() {
    procd_add_reload_trigger "daed"
}
